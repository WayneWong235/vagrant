---


- name: DevOps challenge app test
  hosts: all
  remote_user: root

  vars:

    # Directory to where repository will be cloned
    workdir: /webapps/devops

    # Repository to check out -- YOU MUST CHANGE THIS
    # repo must contain a local.yml file at top level
    #repo_url: git://github.com/sfromm/ansible-playbooks.git
    repo_url: https://bitbucket.org/azneita/devops-challenge.git

  tasks:
    - name: Install ansible
      apt: 
        name: ['ansible', 'git', 'python-pip', 'daemon', 'supervisor'] 
        state: present
      become: true

    - name: Create local directory to work from
      file: 
        path: "{{ workdir }}"
        state: directory
      become: true
    
    - name: Checkout DevOps challenge source code
      git:
        repo: "{{ repo_url }}"
        dest: "{{ workdir }}"
        clone: yes
      become: true

    - name: Install Python Modules
      pip: 
        requirements: "{{ workdir }}/requirements.txt"
      become: true

    - name: create supervisor program config
      action: template src=templates/supervisor.ini dest=/etc/supervisor/flask.ini
      notify:
        - restart flask
      become: true

  handlers:
    - name: restart flask
      action: supervisorctl name=flask state=restarted